app-id: io.github.JuergenFleiss.aTrain
runtime: org.gnome.Platform
runtime-version: "49"
sdk: org.gnome.Sdk
command: run-atrain.sh
finish-args:
  - --socket=wayland
  - --socket=fallback-x11
  - --socket=pulseaudio
  - --device=dri #gpu acceleration
  - --share=ipc #gpu acceleration
  - --share=network #model download
  - --filesystem=xdg-documents #atrain stores transcriptions in ~/Documents/aTrain/...

modules:
  - atrain_python_dependencies.json

  # aTrain Core (Git dependency / backend for atrain)
  - name: atrain-core
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} --no-build-isolation --no-deps .
    sources:
      - type: git
        url: https://github.com/JuergenFleiss/atrain_core.git
        commit: a81ab6fd3639b91fd6e7703a573a082ec5dfd6ce
  # ensure pygments exists in /app for nicegui runtime imports
  - name: pygments
    buildsystem: simple
    build-commands:
      - install -d ${FLATPAK_DEST}/lib/python3.13/site-packages
      - cp -a pygments ${FLATPAK_DEST}/lib/python3.13/site-packages/
    sources:
      - type: git
        url: https://github.com/pygments/pygments.git
        commit: d8400c6ad3d63ee76f8261925c764f4d4cdd7703
    #Main app
  - name: atrain
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} --no-build-isolation --no-deps .
      - sed -i
        -e 's|https://raw.githubusercontent.com/JuergenFleiss/aTrain/v1.4.1/docs/images/screenshot_1.png|https://raw.githubusercontent.com/JuergenFleiss/aTrain/865b4291a31cdfa8d1ab6a5e31998a6df28f752b/share/screenshots/screenshot_1.png|g'
        -e 's|https://raw.githubusercontent.com/JuergenFleiss/aTrain/v1.4.1/docs/images/screenshot_2.png|https://raw.githubusercontent.com/JuergenFleiss/aTrain/865b4291a31cdfa8d1ab6a5e31998a6df28f752b/share/screenshots/screenshot_2.png|g'
        -e 's|https://raw.githubusercontent.com/JuergenFleiss/aTrain/v1.4.1/docs/images/screenshot_3.png|https://raw.githubusercontent.com/JuergenFleiss/aTrain/865b4291a31cdfa8d1ab6a5e31998a6df28f752b/share/screenshots/screenshot_3.png|g'
        -e 's|https://raw.githubusercontent.com/JuergenFleiss/aTrain/v1.4.1/docs/images/screenshot_4.png|https://raw.githubusercontent.com/JuergenFleiss/aTrain/865b4291a31cdfa8d1ab6a5e31998a6df28f752b/share/screenshots/screenshot_4.png|g'
        -e 's|https://raw.githubusercontent.com/JuergenFleiss/aTrain/v1.4.1/docs/images/screenshot_5.png|https://raw.githubusercontent.com/JuergenFleiss/aTrain/865b4291a31cdfa8d1ab6a5e31998a6df28f752b/share/screenshots/screenshot_5.png|g'
        share/metainfo/${FLATPAK_ID}.metainfo.xml
      - install -Dm755 flatpak/run-atrain.sh ${FLATPAK_DEST}/bin/run-atrain.sh
      - install -Dm644 share/icons/${FLATPAK_ID}.svg ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.svg
      - install -Dm644 share/metainfo/${FLATPAK_ID}.metainfo.xml ${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.metainfo.xml
      - install -Dm644 share/applications/${FLATPAK_ID}.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
    sources:
      - type: git
        url: https://github.com/JuergenFleiss/aTrain.git
        commit: 865b4291a31cdfa8d1ab6a5e31998a6df28f752b
